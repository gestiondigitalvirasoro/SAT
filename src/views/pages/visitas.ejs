<!DOCTYPE html>
<html lang="es">
<body>
    <div class="visitas-container" style="margin-top: 100px; padding: 40px 20px;">
        <style>
            .visitas-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                gap: 20px;
                flex-wrap: wrap;
            }

            .visitas-header h1 {
                margin: 0;
                font-size: 1.8rem;
                color: #333;
                flex: 1;
            }

            .btn-crear {
                background: #2563eb;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.3s ease;
                font-size: 0.95rem;
            }

            .btn-crear:hover {
                background: #1d4ed8;
            }

            .filtros-section {
                background: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            .filtros-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .filtro-group {
                display: flex;
                flex-direction: column;
            }

            .filtro-group label {
                font-weight: 600;
                color: #333;
                margin-bottom: 5px;
                font-size: 0.9rem;
            }

            .filtro-group select {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 0.9rem;
                background: white;
                cursor: pointer;
            }

            .calendario-section {
                background: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
                text-align: center;
            }

            .calendario-nav {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                margin-bottom: 15px;
                font-size: 0.95rem;
            }

            .calendario-nav button {
                background: none;
                border: none;
                color: #2563eb;
                font-weight: 600;
                cursor: pointer;
                font-size: 1.2rem;
            }

            .calendario-nav button:hover {
                color: #1d4ed8;
            }

            .tabla-section {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                overflow: auto;
            }

            .tabla-visitas {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9rem;
            }

            .tabla-visitas thead {
                background: #e5e7eb;
            }

            .tabla-visitas th {
                padding: 12px;
                text-align: left;
                font-weight: 600;
                color: #333;
                border-bottom: 2px solid #d1d5db;
            }

            .tabla-visitas td {
                padding: 12px;
                border-bottom: 1px solid #e5e7eb;
                color: #555;
            }

            .tabla-visitas tbody tr:hover {
                background: #f9fafb;
            }

            @media (max-width: 768px) {
                .visitas-header {
                    flex-direction: column;
                    align-items: stretch;
                }

                .btn-crear {
                    width: 100%;
                    text-align: center;
                }

                .filtros-grid {
                    grid-template-columns: 1fr;
                }

                .tabla-visitas {
                    font-size: 0.8rem;
                }

                .tabla-visitas th,
                .tabla-visitas td {
                    padding: 8px;
                }
            }
        </style>

        <!-- Header -->
        <div class="visitas-header">
            <h1>Visitas</h1>
            <button class="btn-crear" onclick="window.location.href='/crear-visita'">Crear</button>
        </div>

        <!-- Filtros -->
        <div class="filtros-section">
            <div class="filtros-grid">
                <div class="filtro-group">
                    <label for="cliente">Cliente:</label>
                    <select id="cliente">
                        <option value="">-- TODOS</option>
                        <option value="empresa1">Empresa 1</option>
                        <option value="empresa2">Empresa 2</option>
                    </select>
                </div>
                <div class="filtro-group">
                    <label for="formulario">Formulario:</label>
                    <select id="formulario">
                        <option value="">-- TODOS</option>
                        <option value="GE">Gesti√≥n Empresaria (GE)</option>
                        <option value="VL">Vigilancia Laboral (VL)</option>
                        <option value="RO">Relevamiento Organizacional (RO)</option>
                    </select>
                </div>
                <div class="filtro-group">
                    <label for="profesional">Profesional:</label>
                    <select id="profesional">
                        <option value="">-- TODOS</option>
                        <option value="prof1">Profesional 1</option>
                        <option value="prof2">Profesional 2</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Calendario -->
        <div class="calendario-section">
            <div class="calendario-nav">
                <button onclick="previousMonth()">&laquo;</button>
                <span id="mesAnio">Enero de 2026</span>
                <button onclick="nextMonth()">&raquo;</button>
                <span style="color: #2563eb; cursor: pointer;" onclick="mostrarMesActual()">este mes</span>
            </div>
        </div>

        <!-- Tabla de visitas -->
        <div class="tabla-section">
            <table class="tabla-visitas">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Empresa</th>
                        <th>Locaci√≥n</th>
                        <th>Profesional</th>
                        <th>Formulario</th>
                        <th>Tarea</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas se llenar√°n con datos de la API -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let mesActual = new Date().getMonth();
        let anioActual = new Date().getFullYear();

        function actualizarMesAnio() {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('mesAnio').textContent = meses[mesActual] + ' de ' + anioActual;
            cargarVisitas();
        }

        function previousMonth() {
            mesActual--;
            if (mesActual < 0) {
                mesActual = 11;
                anioActual--;
            }
            actualizarMesAnio();
        }

        function nextMonth() {
            mesActual++;
            if (mesActual > 11) {
                mesActual = 0;
                anioActual++;
            }
            actualizarMesAnio();
        }

        function mostrarMesActual() {
            mesActual = new Date().getMonth();
            anioActual = new Date().getFullYear();
            actualizarMesAnio();
        }

        async function cargarVisitas() {
            try {
                const mesFormato = mesActual + 1; // JavaScript months are 0-11
                console.log(`Cargando visitas para: mes=${mesFormato}, a√±o=${anioActual}`);
                
                const response = await fetch(`/api/visitas-mes?mes=${mesFormato}&anio=${anioActual}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const visitas = await response.json();
                console.log('Datos recibidos:', visitas);
                
                const tbody = document.querySelector('.tabla-visitas tbody');
                tbody.innerHTML = '';
                
                if (!visitas || visitas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No hay visitas registradas para este mes</td></tr>';
                    return;
                }
                
                visitas.forEach((visita, index) => {
                    const row = document.createElement('tr');
                    const fecha = visita.fecha || (visita.created_at ? visita.created_at.split('T')[0] : '');
                    
                    row.innerHTML = `
                        <td style="text-align: center;">
                            <span style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                <span style="cursor: pointer; font-size: 1.1rem;">üëÅÔ∏è</span>
                                <span style="cursor: pointer; color: #2563eb; font-size: 1.1rem;">‚úèÔ∏è</span>
                            </span>
                        </td>
                        <td>${fecha}</td>
                        <td>${visita.empresa || 'N/A'}</td>
                        <td>${visita.locacion || 'N/A'}</td>
                        <td>${visita.profesional || 'N/A'}</td>
                        <td>${visita.formulario || 'N/A'}</td>
                        <td>${visita.tarea || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error cargando visitas:', error);
                const tbody = document.querySelector('.tabla-visitas tbody');
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: red;">Error: ${error.message}</td></tr>`;
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina visitas cargada');
            actualizarMesAnio();
        });
        
        // Por si el DOM ya est√° listo (en caso de que el script se ejecute despu√©s)
        if (document.readyState === 'loading') {
            // DOM a√∫n se est√° cargando, ya se ejecutar√° el listener
        } else {
            // DOM ya est√° listo
            console.log('DOM ya estaba listo, inicializando...');
            actualizarMesAnio();
        }
    </script>
</body>
</html>
